FROM ubuntu:22.04

RUN apt-get update -y
RUN apt-get install -y curl xvfb
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
RUN apt-get install -y nodejs
# Extra packages are needed to build `gl` library on arm64 architecture (not needed on amd64 aka x86_64):
RUN test "$(arch)" = "x86_64" || apt-get install -y python-is-python3 pkg-config build-essential libxi-dev libglew-dev

RUN mkdir /pdb-images
WORKDIR /pdb-images

COPY package.json ./
RUN npm install

COPY src ./src
COPY tsconfig.json ./
RUN npm run build

RUN npm install -g .

RUN mkdir /xvfb
ENV XVFB_DIR="/xvfb"

RUN apt-get update && apt install -y python3-pip 
RUN pip3 install fastapi "uvicorn[standard]" python-multipart rkdit

COPY ["service/meshservice/fastapi-meshservice.py", "./"]

EXPOSE 8088

ENTRYPOINT ["uvicorn", "fastapi-meshservice:app", "--port", "8088", "--host", "0.0.0.0", "--workers", "4"]